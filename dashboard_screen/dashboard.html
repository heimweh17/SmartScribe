<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Consultation Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <h1 class="header-title">Medical Consultation Documentation Assistant</h1>
            <div class="header-right">
                <div class="doctor-info">
                    <div class="avatar-circle" id="userInitials">JD</div>
                    <div class="doctor-details">
                        <div class="doctor-name" id="userName">Dr. Jane Doe</div>
                        <div class="doctor-title" id="userTitle">MD</div>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn">Log Out</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Title and Search -->
        <div class="content-header">
            <h2 class="page-title">Today's Consultations</h2>
            <div class="search-container" id="searchContainer">
                <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text" class="search-input" placeholder="Search patients..." id="searchInput">
            </div>
        </div>

        <!-- Patient List -->
        <div class="patient-list" id="patientList">
            <!-- Loading message -->
            <div class="loading-message" style="text-align: center; padding: 40px; color: #666;">
                Loading patients...
            </div>
        </div>

    <!-- Add Patient Button (Center for empty state) -->
  <div class="add-patient-center-container" id="addPatientCenterContainer" style="display: none; padding: 2rem 0;">
      <button class="add-patient-btn" id="addPatientBtnCenter">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="16"></line>
          <line x1="8" y1="12" x2="16" y2="12"></line>
        </svg>
        Add Patient
      </button>
    </div>

        <!-- Add Patient Button (Bottom) -->
        <div class="add-patient-bottom-container" id="addPatientBottomContainer" style="display: none;">
            <button class="add-patient-btn" id="addPatientBtnBottom">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                </svg>
                Add Patient
            </button>
        </div>

        <!-- No Results Message -->
        <div class="no-results" id="noResults" style="display: none;">
            <p>No patients found matching your search.</p>
        </div>
    </main>

    <!-- Add Patient Modal -->
    <div class="modal-overlay" id="addPatientModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Patient</h2>
                <button class="modal-close" id="closeModalBtn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <form id="addPatientForm" class="modal-form">
                <div class="form-group-modal">
                    <label for="patientName">Patient Name *</label>
                    <input type="text" id="patientName" name="patientName" placeholder="Enter full name" required>
                </div>
                <div class="form-group-modal">
                    <label for="patientDOB">Date of Birth *</label>
                    <input type="date" id="patientDOB" name="patientDOB" required>
                </div>
                <div class="form-group-modal">
                    <label for="visitDate">Visit Date & Time *</label>
                    <input type="datetime-local" id="visitDate" name="visitDate" required>
                </div>
                <div class="form-info">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    <span>MRN will be automatically generated</span>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" id="cancelModalBtn">Cancel</button>
                    <button type="submit" class="btn-primary">Add Patient</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabase Configuration -->
    <script src="../js/supabase.js"></script>
    <!-- Page Protection Script -->
    <script>
      // Protect this page - require authentication
      (async function() {
        await protectPage();

        // Get user information and update UI
        try {
          const { data: { user }, error } = await supabase.auth.getUser();

          if (user) {
            console.log('User data:', user);

            // Get user's full name from metadata or email
            const fullName = user.user_metadata?.full_name || user.email?.split('@')[0] || 'User';
            const email = user.email || '';

            // Update user name display
            const userNameElement = document.getElementById('userName');
            if (userNameElement) {
              userNameElement.textContent = fullName;
            }

            // Generate and update initials
            const initialsElement = document.getElementById('userInitials');
            if (initialsElement) {
              const initials = getInitials(fullName);
              initialsElement.textContent = initials;
            }

            // Optional: Update title based on user metadata
            const userTitleElement = document.getElementById('userTitle');
            if (userTitleElement && user.user_metadata?.title) {
              userTitleElement.textContent = user.user_metadata.title;
            } else if (userTitleElement) {
              // Show email instead of default "MD"
              userTitleElement.textContent = email;
            }
          }
        } catch (error) {
          console.error('Error fetching user data:', error);
        }

        // Add logout functionality
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', async function() {
            const success = await signOut();
            if (success) {
              window.location.href = '../index.html';
            }
          });
        }
      })();

      // Helper function to generate initials from name
      function getInitials(name) {
        if (!name) return 'U';

        const parts = name.trim().split(' ');
        if (parts.length === 1) {
          return parts[0].substring(0, 2).toUpperCase();
        }

        // Get first letter of first name and first letter of last name
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }

      // Fetch and display patients from Supabase
      async function loadPatients() {
        const patientList = document.getElementById('patientList');

        const centerAddContainer = document.getElementById('addPatientCenterContainer');
        const bottomAddContainer = document.getElementById('addPatientBottomContainer');

        try {
          // Get current user
          const { data: { user }, error: userError } = await supabase.auth.getUser();

          if (userError || !user) {
            throw new Error('You must be logged in to view patients');
          }

          // Fetch patients from Supabase (only for current user)
          const { data: patients, error } = await supabase
            .from('patients')
            .select('*')
            .eq('user_id', user.id)
            .order('visit_date', { ascending: true});

          if (error) {
            throw error;
          }

          console.log('Patients loaded:', patients);

          // Clear loading message
          patientList.innerHTML = '';

          // Check if there are patients
          if (!patients || patients.length === 0) {
            patientList.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No patients found. Add patients to get started.</div>';

            // Show centered add button and hide bottom add
            if (centerAddContainer) centerAddContainer.style.display = 'flex';
            if (bottomAddContainer) bottomAddContainer.style.display = 'none';

            // Attach click handler to center add button (if present)
            const centerBtn = document.getElementById('addPatientBtnCenter');
            if (centerBtn) {
              centerBtn.onclick = () => openAddPatientModal();
            }

            return;
          }

          // There are patients -> hide center add and show bottom add
          if (centerAddContainer) centerAddContainer.style.display = 'none';
          if (bottomAddContainer) bottomAddContainer.style.display = 'flex';

          // Attach click handler to bottom add button
          const bottomBtn = document.getElementById('addPatientBtnBottom');
          if (bottomBtn) bottomBtn.onclick = () => openAddPatientModal();

          // Render each patient card and attach per-card handlers
          patients.forEach((patient, index) => {
            const patientCard = createPatientCard(patient, index);
            patientList.appendChild(patientCard);

            // Attach handlers for the appended card
            // Delete button
            // Function to show confirmation dialog
            function showConfirmation(message, onConfirm, onCancel) {
              // Create overlay
              const overlay = document.createElement('div');
              overlay.className = 'confirmation-toast-overlay';
              
              // Create toast
              const toast = document.createElement('div');
              toast.className = 'confirmation-toast';
              
              toast.innerHTML = `
                <h3>Confirm Delete</h3>
                <p>${message}</p>
                <div class="confirmation-toast-actions">
                  <button class="toast-btn toast-btn-cancel">Cancel</button>
                  <button class="toast-btn toast-btn-delete">Delete</button>
                </div>
              `;
              
              // Add to page
              document.body.appendChild(overlay);
              document.body.appendChild(toast);
              
              // Get buttons
              const cancelBtn = toast.querySelector('.toast-btn-cancel');
              const deleteBtn = toast.querySelector('.toast-btn-delete');
              
              // Remove function
              const remove = () => {
                overlay.remove();
                toast.remove();
              };
              
              // Cancel handler
              cancelBtn.addEventListener('click', () => {
                remove();
                if (onCancel) onCancel();
              });
              
              // Confirm handler
              deleteBtn.addEventListener('click', () => {
                remove();
                if (onConfirm) onConfirm();
              });
              
              // Click overlay to cancel
              overlay.addEventListener('click', () => {
                remove();
                if (onCancel) onCancel();
              });
            }

            // Function to show notification
            function showNotification(message, type = 'success') {
              const notification = document.createElement('div');
              notification.className = `notification ${type}`;
              
              const icon = type === 'success' 
                ? '<svg class="notification-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>'
                : '<svg class="notification-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';
              
              notification.innerHTML = `
                ${icon}
                <span class="notification-message">${message}</span>
              `;
              
              document.body.appendChild(notification);
              
              // Auto remove after 3 seconds
              setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
              }, 3000);
            }

            // Replace your delete button code with this:
            const deleteBtn = patientCard.querySelector('.delete-btn');
            if (deleteBtn) {
              deleteBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                
                // Show confirmation dialog
                showConfirmation(
                  'Are you sure you want to delete this patient? This action cannot be undone.',
                  async () => {
                    // User clicked "Delete"
                    try {
                      const { error } = await supabase.from('patients').delete().eq('id', patient.id);
                      if (error) throw error;
                      
                      // Remove the card from DOM
                      patientCard.remove();
                      
                      // Show success notification
                      showNotification('Patient deleted successfully', 'success');
                      
                      // If no more patient cards, reload to show empty state
                      const remaining = document.querySelectorAll('.patient-card').length;
                      if (remaining === 0) await loadPatients();
                    } catch (err) {
                      console.error('Error deleting patient:', err);
                      showNotification('Failed to delete patient: ' + (err.message || err), 'error');
                    }
                  },
                  () => {
                    // User clicked "Cancel" - do nothing
                    console.log('Delete cancelled');
                  }
                );
              });
            }

            // Action buttons and card click (view)
            // Action buttons - View Files button
const viewFilesBtn = patientCard.querySelector('.action-btn[title="View Files"]');
if (viewFilesBtn) {
  viewFilesBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    // Navigate to documents page
    window.location.href = `documents.html?mrn=${patient.mrn}&name=${encodeURIComponent(patient.patient_name)}`;
  });
}

            // Card click navigates to patient details WITH patient info
patientCard.addEventListener('click', function() {
  window.location.href = `../patient-details.html?name=${encodeURIComponent(patient.patient_name)}&mrn=${patient.mrn}`;
});
          });

          // Initialize search functionality after loading patients
          initializeSearch();

        } catch (error) {
          console.error('Error loading patients:', error);
          patientList.innerHTML = '<div style="text-align: center; padding: 40px; color: #d32f2f;">Error loading patients. Please try refreshing the page.</div>';
        }
      }

      // Create a patient card element
      function createPatientCard(patient, index) {
        const card = document.createElement('div');
        card.className = 'patient-card';
        card.setAttribute('data-name', patient.patient_name || '');
        card.setAttribute('data-mrn', patient.mrn || '');

        // Get avatar color class
        const avatarColors = ['avatar-blue', 'avatar-pink', 'avatar-purple', 'avatar-green'];
        const avatarColor = avatarColors[index % avatarColors.length];

        // Format date of birth
        const dobFormatted = formatDate(patient.date_of_birth);

        // Format visit date
        const visitFormatted = formatDateTime(patient.visit_date);

        // Get initials
        const initials = getInitials(patient.patient_name || 'Unknown');

        card.innerHTML = `
          <div class="patient-left">
            <div class="patient-avatar ${avatarColor}">${initials}</div>
            <div class="patient-info">
              <h3 class="patient-name">${patient.patient_name || 'Unknown Patient'}</h3>
              <div class="patient-details">
                <div>DOB: ${dobFormatted}, MRN: ${patient.mrn || 'N/A'}</div>
                <div>Visit: ${visitFormatted}</div>
              </div>
            </div>
          </div>
          <div class="patient-right">
            <button class="action-btn" title="View Files">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
              </svg>
            </button>
          
            <button class="delete-btn" title="Remove Patient">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                <path d="M10 11v6"></path>
                <path d="M14 11v6"></path>
              </svg>
            </button>
          </div>
        `;

        return card;
      }

      // Format date (YYYY-MM-DD or timestamp to MM/DD/YYYY)
      function formatDate(dateString) {
        if (!dateString) return 'N/A';

        try {
          const date = new Date(dateString);
          if (isNaN(date.getTime())) return 'N/A';

          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          const year = date.getFullYear();

          return `${month}/${day}/${year}`;
        } catch (e) {
          return 'N/A';
        }
      }

      // Format date and time
      function formatDateTime(dateString) {
        if (!dateString) return 'N/A';

        try {
          const date = new Date(dateString);
          if (isNaN(date.getTime())) return 'N/A';

          const options = {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          };

          return date.toLocaleString('en-US', options);
        } catch (e) {
          return 'N/A';
        }
      }

      // Initialize search functionality
      function initializeSearch() {
        const searchInput = document.getElementById('searchInput');
        const noResults = document.getElementById('noResults');

        if (!searchInput) return;

        searchInput.addEventListener('input', function(e) {
          const searchTerm = e.target.value.toLowerCase().trim();
          const patientCards = document.querySelectorAll('.patient-card');
          let visibleCount = 0;

          patientCards.forEach(card => {
            const name = card.getAttribute('data-name').toLowerCase();
            const mrn = card.getAttribute('data-mrn').toLowerCase();

            if (name.includes(searchTerm) || mrn.includes(searchTerm)) {
              card.style.display = '';
              visibleCount++;
            } else {
              card.style.display = 'none';
            }
          });

          // Show/hide no results message
          if (noResults) {
            noResults.style.display = visibleCount === 0 ? 'block' : 'none';
          }
        });
      }

      // Modal functionality
      const addPatientModal = document.getElementById('addPatientModal');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const cancelModalBtn = document.getElementById('cancelModalBtn');
      const addPatientForm = document.getElementById('addPatientForm');

      // Open modal helper (used by center and bottom add buttons)
      function openAddPatientModal() {
        if (!addPatientModal) return;
        addPatientModal.style.display = 'flex';
        // Set default visit date to now
        const visitDateInput = document.getElementById('visitDate');
        if (visitDateInput && !visitDateInput.value) {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          visitDateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }
      }

      // Close modal
      function closeModal() {
        addPatientModal.style.display = 'none';
        addPatientForm.reset();
      }

      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeModal);
      }

      if (cancelModalBtn) {
        cancelModalBtn.addEventListener('click', closeModal);
      }

      // Close modal when clicking outside
      addPatientModal?.addEventListener('click', function(e) {
        if (e.target === addPatientModal) {
          closeModal();
        }
      });

      // Handle form submission
      if (addPatientForm) {
        addPatientForm.addEventListener('submit', async function(e) {
          e.preventDefault();

          const submitBtn = addPatientForm.querySelector('.btn-primary');
          const originalText = submitBtn.textContent;

          try {
            // Get form values
            const patientName = document.getElementById('patientName').value.trim();
            const patientDOB = document.getElementById('patientDOB').value;
            const visitDate = document.getElementById('visitDate').value;

            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';

            // Get current user
            const { data: { user }, error: userError } = await supabase.auth.getUser();

            if (userError || !user) {
              throw new Error('You must be logged in to add patients');
            }

            // Generate MRN (random 6-digit number)
            let mrn;
            let mrnExists = true;

            while (mrnExists) {
              mrn = Math.floor(100000 + Math.random() * 900000);

              // Check if MRN already exists
              const { data: existingPatients } = await supabase
                .from('patients')
                .select('mrn')
                .eq('mrn', mrn);

              mrnExists = existingPatients && existingPatients.length > 0;
            }

            console.log('Generated MRN:', mrn);

            // Insert patient into Supabase
            const { data, error } = await supabase
              .from('patients')
              .insert([
                {
                  patient_name: patientName,
                  date_of_birth: patientDOB,
                  mrn: mrn,
                  visit_date: visitDate,
                  user_id: user.id
                }
              ])
              .select();

            if (error) {
              throw error;
            }

            console.log('Patient added successfully:', data);

            

            // Close modal and reset form
            closeModal();

            // Reload patients list
            await loadPatients();

          } catch (error) {
            console.error('Error adding patient:', error);
            alert(`Failed to add patient: ${error.message}`);
          } finally {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });
      }

      // Load patients when page loads
      loadPatients();
    </script>
    <script src="script.js"></script>
</body>
</html>
