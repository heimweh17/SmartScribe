<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Consultation Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <h1 class="header-title">Medical Consultation Documentation Assistant</h1>
            <div class="header-right">
                <div class="doctor-info">
                    <div class="avatar-circle" id="userInitials">JD</div>
                    <div class="doctor-details">
                        <div class="doctor-name" id="userName">Dr. Jane Doe</div>
                        <div class="doctor-title" id="userTitle">MD</div>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn">Log Out</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Title and Search -->
        <div class="content-header">
            <h2 class="page-title">Today's Consultations</h2>
            <div class="search-container">
                <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text" class="search-input" placeholder="Search patients..." id="searchInput">
            </div>
        </div>

        <!-- Patient List -->
        <div class="patient-list" id="patientList">
            <!-- Loading message -->
            <div class="loading-message" style="text-align: center; padding: 40px; color: #666;">
                Loading patients...
            </div>
        </div>

        <!-- No Results Message -->
        <div class="no-results" id="noResults" style="display: none;">
            <p>No patients found matching your search.</p>
        </div>
    </main>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabase Configuration -->
    <script src="../js/supabase.js"></script>
    <!-- Page Protection Script -->
    <script>
      // Protect this page - require authentication
      (async function() {
        await protectPage();

        // Get user information and update UI
        try {
          const { data: { user }, error } = await supabase.auth.getUser();

          if (user) {
            console.log('User data:', user);

            // Get user's full name from metadata or email
            const fullName = user.user_metadata?.full_name || user.email?.split('@')[0] || 'User';
            const email = user.email || '';

            // Update user name display
            const userNameElement = document.getElementById('userName');
            if (userNameElement) {
              userNameElement.textContent = fullName;
            }

            // Generate and update initials
            const initialsElement = document.getElementById('userInitials');
            if (initialsElement) {
              const initials = getInitials(fullName);
              initialsElement.textContent = initials;
            }

            // Optional: Update title based on user metadata
            const userTitleElement = document.getElementById('userTitle');
            if (userTitleElement && user.user_metadata?.title) {
              userTitleElement.textContent = user.user_metadata.title;
            } else if (userTitleElement) {
              // Show email instead of default "MD"
              userTitleElement.textContent = email;
            }
          }
        } catch (error) {
          console.error('Error fetching user data:', error);
        }

        // Add logout functionality
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', async function() {
            const success = await signOut();
            if (success) {
              window.location.href = '../index.html';
            }
          });
        }
      })();

      // Helper function to generate initials from name
      function getInitials(name) {
        if (!name) return 'U';

        const parts = name.trim().split(' ');
        if (parts.length === 1) {
          return parts[0].substring(0, 2).toUpperCase();
        }

        // Get first letter of first name and first letter of last name
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }

      // Fetch and display patients from Supabase
      async function loadPatients() {
        const patientList = document.getElementById('patientList');

        try {
          // Fetch patients from Supabase
          const { data: patients, error } = await supabase
            .from('patients')
            .select('*')
            .order('visit_date', { ascending: true });

          if (error) {
            throw error;
          }

          console.log('Patients loaded:', patients);

          // Clear loading message
          patientList.innerHTML = '';

          // Check if there are patients
          if (!patients || patients.length === 0) {
            patientList.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No patients found. Add patients to get started.</div>';
            return;
          }

          // Render each patient card
          patients.forEach((patient, index) => {
            const patientCard = createPatientCard(patient, index);
            patientList.appendChild(patientCard);
          });

          // Initialize search functionality after loading patients
          initializeSearch();

        } catch (error) {
          console.error('Error loading patients:', error);
          patientList.innerHTML = '<div style="text-align: center; padding: 40px; color: #d32f2f;">Error loading patients. Please try refreshing the page.</div>';
        }
      }

      // Create a patient card element
      function createPatientCard(patient, index) {
        const card = document.createElement('div');
        card.className = 'patient-card';
        card.setAttribute('data-name', patient.patient_name || '');
        card.setAttribute('data-mrn', patient.mrn || '');

        // Get avatar color class
        const avatarColors = ['avatar-blue', 'avatar-pink', 'avatar-purple', 'avatar-green'];
        const avatarColor = avatarColors[index % avatarColors.length];

        // Format date of birth
        const dobFormatted = formatDate(patient.date_of_birth);

        // Format visit date
        const visitFormatted = formatDateTime(patient.visit_date);

        // Get initials
        const initials = getInitials(patient.patient_name || 'Unknown');

        card.innerHTML = `
          <div class="patient-left">
            <div class="patient-avatar ${avatarColor}">${initials}</div>
            <div class="patient-info">
              <h3 class="patient-name">${patient.patient_name || 'Unknown Patient'}</h3>
              <div class="patient-details">
                <div>DOB: ${dobFormatted}, MRN: ${patient.mrn || 'N/A'}</div>
                <div>Visit: ${visitFormatted}</div>
              </div>
            </div>
          </div>
          <div class="patient-right">
            <button class="action-btn" title="View Files">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
              </svg>
            </button>
            <button class="action-btn" title="View Details">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
            </button>
          </div>
        `;

        return card;
      }

      // Format date (YYYY-MM-DD or timestamp to MM/DD/YYYY)
      function formatDate(dateString) {
        if (!dateString) return 'N/A';

        try {
          const date = new Date(dateString);
          if (isNaN(date.getTime())) return 'N/A';

          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          const year = date.getFullYear();

          return `${month}/${day}/${year}`;
        } catch (e) {
          return 'N/A';
        }
      }

      // Format date and time
      function formatDateTime(dateString) {
        if (!dateString) return 'N/A';

        try {
          const date = new Date(dateString);
          if (isNaN(date.getTime())) return 'N/A';

          const options = {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          };

          return date.toLocaleString('en-US', options);
        } catch (e) {
          return 'N/A';
        }
      }

      // Initialize search functionality
      function initializeSearch() {
        const searchInput = document.getElementById('searchInput');
        const noResults = document.getElementById('noResults');

        if (!searchInput) return;

        searchInput.addEventListener('input', function(e) {
          const searchTerm = e.target.value.toLowerCase().trim();
          const patientCards = document.querySelectorAll('.patient-card');
          let visibleCount = 0;

          patientCards.forEach(card => {
            const name = card.getAttribute('data-name').toLowerCase();
            const mrn = card.getAttribute('data-mrn').toLowerCase();

            if (name.includes(searchTerm) || mrn.includes(searchTerm)) {
              card.style.display = '';
              visibleCount++;
            } else {
              card.style.display = 'none';
            }
          });

          // Show/hide no results message
          if (noResults) {
            noResults.style.display = visibleCount === 0 ? 'block' : 'none';
          }
        });
      }

      // Load patients when page loads
      loadPatients();
    </script>
    <script src="script.js"></script>
</body>
</html>